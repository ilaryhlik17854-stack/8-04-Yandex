# Домашнее задание к занятию «Подъём инфраструктуры в Yandex Cloud»

### Оформление домашнего задания

1. Домашнее задание выполните в [Google Docs](https://docs.google.com/) и отправьте на проверку ссылку на ваш документ в личном кабинете.  
1. В названии файла укажите номер лекции и фамилию студента. Пример названия: 7.3. Подъём инфраструктуры в Yandex Cloud — Александр Александров.
1. Перед отправкой проверьте, что доступ для просмотра открыт всем, у кого есть ссылка. Если нужно прикрепить дополнительные ссылки, добавьте их в свой Google Docs.

Вы можете прислать решение в виде ссылки на ваш репозийторий в GitHub, для этого воспользуйтесь [шаблоном для домашнего задания](https://github.com/netology-code/sys-pattern-homework).

 ---
## Важно

Перед началом работы над дипломным заданием изучите [Инструкция по экономии облачных ресурсов](https://github.com/netology-code/devops-materials/blob/master/cloudwork.MD).

---

### Задание 1 

Повторить демонстрацию лекции(развернуть vpc, 2 веб сервера, бастион сервер)

### Задание 2 

С помощью ansible подключиться к web-a и web-b , установить на них nginx.(написать нужный ansible playbook)


Провести тестирование и приложить скриншоты развернутых в облаке ВМ, успешно отработавшего ansible playbook. 

Для выполнениея задания подготовим конфигурационные файлы представленные в лекции

В файле cloud-init.yml заменим строку на ключ который предварительно создадим на VM

```
ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMNPGyB0jwD/j3RiUdjAM25Pd3mK9Ps9Dvpc4iQ3wo1k udjin@webinar
```
получится

```
 ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMZxlZGdiZZJqZGngA/t24bFNt6h7/4eje/SfrAY8Q4J ubuntu@ubuntu2204
```
для файла providers.tf создадим authorized_key.json 

Для создания authorized_key.json содадим сервисный аккаунт и ключ к нему
![ZD703-1](https://github.com/ilaryhlik17854-stack/8-04-Yandex/blob/main/img/Service_account.png?raw=true)

В variables.tf
поменяем cloud_id и folder_id

```
ariable "flow" {
  type    = string
  default = "24-01"
}

variable "cloud_id" {
  type    = string
  default = "b1gn3ndpua1j6jaabf79"
}
variable "folder_id" {
  type    = string
  default = "b1gfu61oc15cb99nqmfe"
}

variable "test" {
  type = map(number)
  default = {
    cores         = 2
    memory        = 1
    core_fraction = 20
  }
}
```

В файле vms.tf заменим на более актульный образ ubuntu-2404-lts-oslogin
```
data "yandex_compute_image" "***" {
  family = "***"
```

выполним иницилизацию проекта

```
terraform init
```
![ZD703-2](https://github.com/ilaryhlik17854-stack/8-04-Yandex/blob/main/img/init.png?raw=true)


смотрим изменения

```
terraform plan
```
![ZD703-3](https://github.com/ilaryhlik17854-stack/8-04-Yandex/blob/main/img/plan.png?raw=true)

применяем 

```
terraform apply
```
![ZD703-4](https://github.com/ilaryhlik17854-stack/8-04-Yandex/blob/main/img/apply.png?raw=true)

Скриншот страницы Yandex https://console.yandex.cloud

![ZD703-5](https://github.com/ilaryhlik17854-stack/8-04-Yandex/blob/main/img/yandex.png?raw=true)

С помощью ansible подключиться к web-a и web-b , установить на них nginx

```
---
- name: test
  gather_facts: false
  hosts: webservers
  vars:
    ansible_ssh_user: user
  become: yes

  pre_tasks:
    - name: Validating the ssh port is open and
      wait_for:
        host: "{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}"
        port: 22
        delay: 5
        timeout: 600
        state: started
        search_regex: OpenSSH

  tasks:
    - name: create test file
      copy:
        dest: /tmp/test
        content: "RUKHLIKIA"

    - name: Ensure Nginx is installed
      apt:
        name: nginx
        state: present
        update_cache: yes

    - name: copy index
      template:
        src: /home/ubuntu/index.html  # Путь к вашему файлу с содержимым сайта
        dest: /var/www/html/index.html


    - name: Start Nginx service
      service:
        name: nginx
        state: started
        enabled: yes

    - name: Check Nginx service status
      debug:
        msg: "Nginx is running: {{ ansible_facts.services['nginx.service'] is defined and ansible_facts.services['nginx.service'].state == 'running' }}"


```

выполним команду ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i ./hosts.ini test.yml

![ZD703-5](https://github.com/ilaryhlik17854-stack/8-04-Yandex/blob/main/img/playbook.png?raw=true)

зайдем на удаленный хост и проверим

![ZD703-6](https://github.com/ilaryhlik17854-stack/8-04-Yandex/blob/main/img/ssh1.png?raw=true)

```
ssh -J user@89.169.149.208 user@10.0.1.8
```

![ZD703-7](https://github.com/ilaryhlik17854-stack/8-04-Yandex/blob/main/img/ssh2.png?raw=true)

```
ssh user@89.169.149.208
```
